<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LC-5200 Datapath Visualizer</title>
<style>
  /* ========== RESET & BASE ========== */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', 'Roboto', 'Segoe UI', sans-serif;
    background: #f5f5f5;
    color: #2c3e50;
    min-height: 100vh;
  }

  /* ========== HEADER ========== */
  .header {
    background: #2c3e50;
    color: #fff;
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .header h1 { font-size: 18px; font-weight: 600; letter-spacing: 0.3px; }
  .header-subtitle { font-size: 12px; color: #95a5a6; font-weight: 400; }

  /* ========== CONTROL BAR ========== */
  .control-bar {
    background: #fff;
    border-bottom: 1px solid #dcdde1;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  .control-bar label {
    font-size: 13px;
    font-weight: 600;
    color: #34495e;
  }
  .control-bar select {
    font-family: inherit;
    font-size: 13px;
    padding: 6px 10px;
    border: 1px solid #bdc3c7;
    border-radius: 3px;
    background: #fff;
    color: #2c3e50;
    cursor: pointer;
    min-width: 200px;
  }
  .control-bar select:focus { outline: none; border-color: #3498db; }

  .btn {
    font-family: inherit;
    font-size: 13px;
    padding: 6px 14px;
    border: 1px solid #bdc3c7;
    border-radius: 3px;
    background: #ecf0f1;
    color: #2c3e50;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.15s;
  }
  .btn:hover:not(:disabled) { background: #d5dbdb; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; background: #ecf0f1; }
  .btn-primary { background: #3498db; color: #fff; border-color: #2980b9; }
  .btn-primary:hover:not(:disabled) { background: #2980b9; }

  .cycle-info {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    margin-left: auto;
    text-align: right;
  }
  .cycle-info .state-name {
    font-size: 14px;
    color: #e74c3c;
    font-weight: 700;
    font-family: 'Consolas', 'Monaco', monospace;
  }

  /* ========== MAIN LAYOUT ========== */
  .main {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 0;
    height: calc(100vh - 105px);
  }

  /* ========== DATAPATH PANEL ========== */
  .datapath-panel {
    padding: 16px;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
  }
  .datapath-panel svg {
    max-width: 100%;
    height: auto;
  }

  /* ========== SIGNAL PANEL ========== */
  .signal-panel {
    background: #fff;
    border-left: 1px solid #dcdde1;
    padding: 0;
    overflow-y: auto;
  }
  .signal-panel-header {
    padding: 12px 16px;
    background: #34495e;
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .signal-section {
    padding: 8px 0;
    border-bottom: 1px solid #ecf0f1;
  }
  .signal-section-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #7f8c8d;
    padding: 4px 16px 6px;
  }
  .signal-item {
    display: flex;
    align-items: center;
    padding: 3px 16px 3px 16px;
    font-size: 12px;
    font-family: 'Consolas', 'Monaco', monospace;
    border-left: 3px solid transparent;
    transition: all 0.15s;
  }
  .signal-item.active {
    background: #ffebee;
    border-left-color: #e74c3c;
    font-weight: 700;
  }
  .signal-name { flex: 1; color: #34495e; }
  .signal-value { color: #7f8c8d; min-width: 20px; text-align: right; }
  .signal-item.active .signal-value { color: #e74c3c; }

  .description-box {
    padding: 12px 16px;
    background: #fafafa;
    border-bottom: 1px solid #ecf0f1;
  }
  .description-box h3 {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #7f8c8d;
    margin-bottom: 6px;
  }
  .description-box p {
    font-size: 12px;
    line-height: 1.5;
    color: #2c3e50;
  }
  .alu-info, .reg-info {
    margin-top: 4px;
    font-size: 11px;
    font-weight: 600;
  }
  .alu-info { color: #8e44ad; }
  .reg-info { color: #2980b9; }

  /* ========== SVG STYLES ========== */
  .comp-rect {
    fill: #ecf0f1;
    stroke: #2c3e50;
    stroke-width: 2;
    transition: fill 0.2s, stroke 0.2s;
  }
  .comp-rect.active {
    fill: #ffebee;
    stroke: #e74c3c;
    stroke-width: 2.5;
  }
  .comp-label {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    font-size: 13px;
    font-weight: 700;
    fill: #2c3e50;
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
  }
  .comp-sublabel {
    font-family: 'Inter', 'Segoe UI', sans-serif;
    font-size: 9px;
    font-weight: 400;
    fill: #7f8c8d;
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
  }
  .signal-label {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 9px;
    fill: #7f8c8d;
    pointer-events: none;
  }
  .signal-label.active { fill: #e74c3c; font-weight: 700; }
  .data-path {
    fill: none;
    stroke: #bdc3c7;
    stroke-width: 2;
    transition: stroke 0.2s, stroke-width 0.2s;
  }
  .data-path.active {
    stroke: #e74c3c;
    stroke-width: 3.5;
  }
  .bus-line {
    fill: none;
    stroke: #2c3e50;
    stroke-width: 4;
  }
  .bus-line.active-bus {
    stroke: #e74c3c;
    stroke-width: 5;
  }
  .tri-state {
    fill: #d5f5e3;
    stroke: #2c3e50;
    stroke-width: 1.5;
    transition: fill 0.2s, stroke 0.2s;
  }
  .tri-state.active {
    fill: #e74c3c;
    stroke: #c0392b;
  }
  .ctrl-line {
    fill: none;
    stroke: #bdc3c7;
    stroke-width: 1;
    stroke-dasharray: 4 2;
  }
  .ctrl-line.active {
    stroke: #e74c3c;
    stroke-width: 1.5;
    stroke-dasharray: none;
  }

  /* ========== ANIMATION DOT ========== */
  .anim-dot {
    pointer-events: none;
  }

  /* ========== KEYBOARD HINT ========== */
  .toggle-label {
    font-size: 12px;
    color: #2c3e50;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-right: 16px;
  }
  .toggle-label input { cursor: pointer; }
  .kb-hint {
    font-size: 11px;
    color: #95a5a6;
    padding: 0 24px 0 0;
  }
  .kb-hint kbd {
    background: #ecf0f1;
    border: 1px solid #bdc3c7;
    border-radius: 2px;
    padding: 1px 5px;
    font-family: inherit;
    font-size: 11px;
  }
</style>
</head>
<body>

<!-- ========== HEADER ========== -->
<div class="header">
  <div>
    <h1>LC-5200 Datapath Visualizer</h1>
    <div class="header-subtitle">Microcode Cycle-by-Cycle Execution</div>
  </div>
</div>

<!-- ========== CONTROL BAR ========== -->
<div class="control-bar">
  <label for="instr-select">Instruction:</label>
  <select id="instr-select"></select>
  <button class="btn" id="btn-prev" disabled>&larr; Previous</button>
  <button class="btn btn-primary" id="btn-next">Next &rarr;</button>
  <label class="toggle-label"><input type="checkbox" id="fetch-toggle" checked> Show Fetch</label>
  <label class="toggle-label"><input type="checkbox" id="anim-toggle" checked> Animate Flow</label>
  <span class="kb-hint">Use <kbd>&larr;</kbd> <kbd>&rarr;</kbd> arrow keys</span>
  <div class="cycle-info">
    <div id="cycle-counter">Cycle 1/6</div>
    <div class="state-name" id="state-name">FETCH0</div>
  </div>
</div>

<!-- ========== MAIN ========== -->
<div class="main">

  <!-- DATAPATH SVG -->
  <div class="datapath-panel">
    <svg id="datapath-svg" viewBox="0 0 960 580" xmlns="http://www.w3.org/2000/svg">

      <defs>
        <filter id="glow">
          <feGaussianBlur stdDeviation="2.5" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>

      <!-- ==========================================================
           LAYER 1 (BACK): ALL DATA PATHS
           Drawn first so they render behind bus and components.
           ========================================================== -->

      <!-- PC paths -->
      <line id="path-bus-pc" class="data-path" x1="105" y1="12" x2="105" y2="45"/>
      <line id="path-pc-down" class="data-path" x1="105" y1="85" x2="105" y2="350"/>
      <line id="path-DrPC-bus" class="data-path" x1="105" y1="375" x2="105" y2="400"/>

      <!-- Reg A paths -->
      <line id="path-bus-a" class="data-path" x1="210" y1="12" x2="210" y2="45"/>
      <line id="path-a-alu" class="data-path" x1="225" y1="85" x2="225" y2="150"/>

      <!-- Reg B paths -->
      <line id="path-bus-b" class="data-path" x1="350" y1="12" x2="350" y2="45"/>
      <line id="path-b-alu" class="data-path" x1="335" y1="85" x2="335" y2="150"/>

      <!-- MAR paths -->
      <line id="path-bus-mar" class="data-path" x1="625" y1="12" x2="625" y2="45"/>
      <line id="path-mar-mem" class="data-path" x1="625" y1="85" x2="625" y2="130"/>

      <!-- IR paths -->
      <line id="path-bus-ir" class="data-path" x1="870" y1="12" x2="870" y2="45"/>
      <line id="path-ir-se" class="data-path" x1="870" y1="85" x2="870" y2="120"/>
      <line id="path-bl-se" class="data-path" x1="870" y1="165" x2="870" y2="190"/>

      <!-- ALU paths -->
      <line id="path-alu-down" class="data-path" x1="275" y1="280" x2="275" y2="350"/>
      <line id="path-DrALU-bus" class="data-path" x1="275" y1="375" x2="275" y2="400"/>

      <!-- Register File paths -->
      <line id="path-bus-regfile" class="data-path" x1="475" y1="12" x2="475" y2="130"/>
      <line id="path-regfile-down" class="data-path" x1="475" y1="240" x2="475" y2="350"/>
      <line id="path-DrREG-bus" class="data-path" x1="475" y1="375" x2="475" y2="400"/>

      <!-- Memory paths -->
      <line id="path-bus-mem-din" class="data-path" x1="695" y1="12" x2="695" y2="130"/>
      <line id="path-mem-down" class="data-path" x1="665" y1="240" x2="665" y2="350"/>
      <line id="path-DrMEM-bus" class="data-path" x1="665" y1="375" x2="665" y2="400"/>

      <!-- Sign Extend paths -->
      <line id="path-se-down" class="data-path" x1="870" y1="240" x2="870" y2="350"/>
      <line id="path-DrOFF-bus" class="data-path" x1="870" y1="375" x2="870" y2="400"/>

      <!-- Comparison Logic paths -->
      <line id="path-alu-cmp" class="data-path" x1="180" y1="400" x2="180" y2="460"/>
      <line id="path-cmp-out" class="data-path" x1="180" y1="510" x2="180" y2="545"/>
      <line id="path-cmp-out-2" class="data-path" x1="180" y1="545" x2="410" y2="545"/>

      <!-- ==========================================================
           LAYER 2 (MIDDLE): MAIN BUS
           Drawn after paths so it covers path/bus intersections.
           ========================================================== -->
      <polyline id="bus-main" class="bus-line" points="920,12 20,12 20,400 920,400"/>
      <text x="18" y="210" class="signal-label" style="font-size:10px;fill:#2c3e50;font-weight:700;"
            transform="rotate(-90,15,210)">BUS</text>

      <!-- ==========================================================
           LAYER 3 (FRONT): COMPONENTS, TRI-STATES, LABELS, CONTROLS
           Drawn last so components sit on top of everything.
           ========================================================== -->

      <!-- ===== PC ===== -->
      <rect id="comp-pc" class="comp-rect" x="70" y="45" width="70" height="40" rx="3"/>
      <text x="105" y="65" class="comp-label">PC</text>
      <text id="lbl-LdPC" class="signal-label" x="40" y="60">LdPC</text>
      <line id="ctrl-LdPC" class="ctrl-line" x1="64" y1="58" x2="70" y2="58"/>
      <polygon id="tri-DrPC" class="tri-state" points="90,350 120,350 105,375"/>
      <text id="lbl-DrPC" class="signal-label" x="68" y="365">DrPC</text>

      <!-- ===== REG A ===== -->
      <rect id="comp-a" class="comp-rect" x="195" y="45" width="60" height="40" rx="3"/>
      <text x="225" y="65" class="comp-label">A</text>
      <text id="lbl-LdA" class="signal-label" x="170" y="60">LdA</text>
      <line id="ctrl-LdA" class="ctrl-line" x1="190" y1="58" x2="195" y2="58"/>

      <!-- ===== REG B ===== -->
      <rect id="comp-b" class="comp-rect" x="305" y="45" width="60" height="40" rx="3"/>
      <text x="335" y="65" class="comp-label">B</text>
      <text id="lbl-LdB" class="signal-label" x="374" y="60">LdB</text>
      <line id="ctrl-LdB" class="ctrl-line" x1="365" y1="58" x2="370" y2="58"/>

      <!-- ===== MAR ===== -->
      <rect id="comp-mar" class="comp-rect" x="590" y="45" width="70" height="40" rx="3"/>
      <text x="625" y="65" class="comp-label">MAR</text>
      <text id="lbl-LdMAR" class="signal-label" x="555" y="60">LdMAR</text>
      <line id="ctrl-LdMAR" class="ctrl-line" x1="585" y1="58" x2="590" y2="58"/>
      <text x="612" y="103" class="comp-sublabel" style="font-size:8px;">16</text>
      <line id="ctrl-LdMAR" class="ctrl-line" x1="620" y1="105" x2="630" y2="100"/>

      <!-- ===== IR ===== -->
      <rect id="comp-ir" class="comp-rect" x="835" y="45" width="70" height="40" rx="3"/>
      <text x="870" y="65" class="comp-label">IR</text>
      <text id="lbl-LdIR" class="signal-label" x="805" y="60">LdIR</text>
      <line id="ctrl-LdIR" class="ctrl-line" x1="830" y1="58" x2="835" y2="58"/>
      <text x="870" y="125" class="comp-sublabel" style="text-anchor:middle;">IR[31:0]</text>
      <text x="870" y="160" class="comp-sublabel" style="text-anchor:middle;">IR[19:0]</text>

      <!-- ===== ALU ===== -->
      <polygon id="comp-alu" class="comp-rect" points="190,130 360,130 330,280 220,280"/>
      <text x="275" y="160" class="comp-label">ALU</text>
      <text id="alu-func-text" x="275" y="180" class="comp-sublabel">func: ADD</text>
      <text x="275" y="205" class="comp-sublabel" style="text-anchor:middle;font-size:10px;fill:#555;">
        <tspan x="275" dy="0">000: ADD</tspan>
        <tspan x="275" dy="10">001: SUB</tspan>
        <tspan x="275" dy="10">010: NAND</tspan>
        <tspan x="275" dy="10">011: A+1</tspan>
        <tspan x="275" dy="10">100: PASS A</tspan>
        <tspan x="275" dy="10">101: PASS B</tspan>
      </text>
      <text id="lbl-ALUfunc" class="signal-label" x="160" y="202">func</text>
      <line id="ctrl-ALUfunc" class="ctrl-line" x1="185" y1="200" x2="205" y2="200"/>
      <text x="190" y="210" class="comp-sublabel" style="font-size:7px;text-anchor:middle;">3</text>
      <line id="ctrl-ALUfuncbit" class="ctrl-line" x1="190" y1="205" x2="195" y2="195"/>
      <polygon id="tri-DrALU" class="tri-state" points="260,350 290,350 275,375"/>
      <text id="lbl-DrALU" class="signal-label" x="238" y="365">DrALU</text>

      <!-- ===== REGISTER FILE ===== -->
      <rect id="comp-regfile" class="comp-rect" x="410" y="130" width="130" height="110" rx="3"/>
      <text x="475" y="170" class="comp-label">Registers</text>
      <text x="475" y="187" class="comp-sublabel">16 x 32 bits</text>
      <text id="lbl-WrREG" class="signal-label" x="400" y="150" style="text-anchor:end;">WrREG</text>
      <line id="ctrl-WrREG" class="ctrl-line" x1="405" y1="148" x2="410" y2="148"/>
      <text x="475" y="140" class="comp-sublabel" style="text-anchor:middle;">Din</text>
      <text x="398" y="209" class="comp-sublabel" style="text-anchor:end;">regno</text>
      <line class="ctrl-line" x1="402" y1="210" x2="410" y2="210"/>
      <text x="405" y="220" class="comp-sublabel" style="text-anchor:end;font-size:7px;">4</text>
      <text id="regno-text" x="385" y="200" class="comp-sublabel" style="text-anchor:middle;fill:#2980b9;font-weight:600;">Ry</text>
      <line id="ctrl-regnobits" class="ctrl-line" x1="403" y1="214" x2="407" y2="206"/>
      <text x="475" y="230" class="comp-sublabel" style="text-anchor:middle;">Dout</text>
      <polygon id="tri-DrREG" class="tri-state" points="460,350 490,350 475,375"/>
      <text id="lbl-DrREG" class="signal-label" x="438" y="365">DrREG</text>

      <!-- ===== MEMORY ===== -->
      <rect id="comp-mem" class="comp-rect" x="600" y="130" width="130" height="110" rx="3"/>
      <text x="665" y="170" class="comp-label">Memory</text>
      <text x="665" y="187" class="comp-sublabel">2^16 x 32 bits</text>
      <text id="lbl-WrMEM" class="signal-label" x="590" y="150" style="text-anchor:end;">WrMEM</text>
      <line id="ctrl-WrMEM" class="ctrl-line" x1="595" y1="148" x2="600" y2="148"/>
      <text x="698" y="140" class="comp-sublabel" style="text-anchor:middle;">Din</text>
      <text x="665" y="230" class="comp-sublabel" style="text-anchor:middle;">Dout</text>
      <polygon id="tri-DrMEM" class="tri-state" points="650,350 680,350 665,375"/>
      <text id="lbl-DrMEM" class="signal-label" x="628" y="365">DrMEM</text>
      <text x="628" y="140" class="comp-sublabel">Addr</text>

      <!-- ===== SIGN EXTEND ===== -->
      <rect id="comp-se" class="comp-rect" x="835" y="190" width="70" height="50" rx="3"/>
      <text x="870" y="205" class="comp-label" style="font-size:11px;">Sign</text>
      <text x="870" y="220" class="comp-label" style="font-size:11px;">Extend</text>
      <polygon id="tri-DrOFF" class="tri-state" points="855,350 885,350 870,375"/>
      <text id="lbl-DrOFF" class="signal-label" x="833" y="365">DrOFF</text>

      <!-- ===== COMPARISON LOGIC ===== -->
      <rect id="comp-cmp" class="comp-rect" x="115" y="460" width="130" height="50" rx="3"/>
      <text x="180" y="480" class="comp-label" style="font-size:11px;">Comparison</text>
      <text x="180" y="496" class="comp-label" style="font-size:11px;">Logic</text>
      <text id="lbl-ChkCmp" class="signal-label" x="72" y="480">ChkCmp</text>
      <line id="ctrl-ChkCmp" class="ctrl-line" x1="105" y1="478" x2="115" y2="478"/>
      <line id="ctrl-ChkCmpdata" class="ctrl-line" x1="107" y1="482" x2="112" y2="474"/>
      <text x="110" y="488" class="comp-sublabel" style="font-size:7px;text-anchor:end;">2</text>
      <text x="420" y="544" class="comp-sublabel" style="text-anchor:start;font-size:9px;">CmpTrue - to microcontroller</text>
      <text x="190" y="558" class="comp-sublabel" style="text-anchor:end;font-size:7px;">1</text>
      <line id="ctrl-cmpoutdata" class="ctrl-line" x1="187" y1="550" x2="192" y2="542"/>

      <!-- ===== IR DECODE LABELS ===== -->
      <text x="420" y="470" class="comp-sublabel" style="text-anchor:start;font-size:9px;fill:#34495e;">
        <tspan x="420" dy="0">IR[31:28] -- OP: 4-bit opcode to control logic</tspan>
        <tspan x="420" dy="14">IR[27:24] -- Rx: 4-bit register number</tspan>
        <tspan x="420" dy="14">IR[23:20] -- Ry: 4-bit register number</tspan>
        <tspan x="420" dy="14">IR[3:0]      -- Rz: 4-bit register number</tspan>
      </text>

      <!-- ===== ANIMATION ELEMENTS (topmost layer) ===== -->
      <circle id="anim-dot" class="anim-dot" r="6" fill="#e74c3c" opacity="0" filter="url(#glow)"/>
      <path id="anim-route" fill="none" stroke="none" d=""/>

    </svg>
  </div>

  <!-- SIGNAL PANEL -->
  <div class="signal-panel">
    <div class="signal-panel-header">Control Signals</div>

    <div class="description-box">
      <h3>Cycle Description</h3>
      <p id="cycle-description">Select an instruction to begin.</p>
      <div id="alu-info-box" class="alu-info"></div>
      <div id="reg-info-box" class="reg-info"></div>
    </div>

    <div class="signal-section">
      <div class="signal-section-title">Load Signals</div>
      <div id="sig-LdPC" class="signal-item"><span class="signal-name">LdPC</span><span class="signal-value">0</span></div>
      <div id="sig-LdA" class="signal-item"><span class="signal-name">LdA</span><span class="signal-value">0</span></div>
      <div id="sig-LdB" class="signal-item"><span class="signal-name">LdB</span><span class="signal-value">0</span></div>
      <div id="sig-LdMAR" class="signal-item"><span class="signal-name">LdMAR</span><span class="signal-value">0</span></div>
      <div id="sig-LdIR" class="signal-item"><span class="signal-name">LdIR</span><span class="signal-value">0</span></div>
    </div>

    <div class="signal-section">
      <div class="signal-section-title">Drive Signals</div>
      <div id="sig-DrPC" class="signal-item"><span class="signal-name">DrPC</span><span class="signal-value">0</span></div>
      <div id="sig-DrALU" class="signal-item"><span class="signal-name">DrALU</span><span class="signal-value">0</span></div>
      <div id="sig-DrREG" class="signal-item"><span class="signal-name">DrREG</span><span class="signal-value">0</span></div>
      <div id="sig-DrMEM" class="signal-item"><span class="signal-name">DrMEM</span><span class="signal-value">0</span></div>
      <div id="sig-DrOFF" class="signal-item"><span class="signal-name">DrOFF</span><span class="signal-value">0</span></div>
    </div>

    <div class="signal-section">
      <div class="signal-section-title">Write Signals</div>
      <div id="sig-WrREG" class="signal-item"><span class="signal-name">WrREG</span><span class="signal-value">0</span></div>
      <div id="sig-WrMEM" class="signal-item"><span class="signal-name">WrMEM</span><span class="signal-value">0</span></div>
    </div>

    <div class="signal-section">
      <div class="signal-section-title">ALU Control</div>
      <div id="sig-ALU2" class="signal-item"><span class="signal-name">ALU2</span><span class="signal-value">0</span></div>
      <div id="sig-ALU1" class="signal-item"><span class="signal-name">ALU1</span><span class="signal-value">0</span></div>
      <div id="sig-ALU0" class="signal-item"><span class="signal-name">ALU0</span><span class="signal-value">0</span></div>
    </div>

    <div class="signal-section">
      <div class="signal-section-title">Register Select</div>
      <div id="sig-RegSelHi" class="signal-item"><span class="signal-name">RegSelHi</span><span class="signal-value">0</span></div>
      <div id="sig-RegSelLo" class="signal-item"><span class="signal-name">RegSelLo</span><span class="signal-value">0</span></div>
    </div>

    <div class="signal-section">
      <div class="signal-section-title">Comparison</div>
      <div id="sig-ChkCmpHi" class="signal-item"><span class="signal-name">ChkCmpHi</span><span class="signal-value">0</span></div>
      <div id="sig-ChkCmpLo" class="signal-item"><span class="signal-name">ChkCmpLo</span><span class="signal-value">0</span></div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   LC-5200 MICROCODE DATA
   Extracted from microcode.xlsx
   ============================================================ */

const SIGNAL_NAMES = [
  'RegSelHi','RegSelLo','ALU2','ALU1','ALU0',
  'WrMEM','WrREG','LdB','LdA','LdMAR','LdIR','LdPC',
  'DrOFF','DrPC','DrALU','DrMEM','DrREG',
  'ChkCmpHi','ChkCmpLo'
];

function ms(name, sigArray, desc) {
  const signals = {};
  SIGNAL_NAMES.forEach((n, i) => { signals[n] = sigArray[i] || 0; });
  return { name, signals, description: desc };
}

// ---- FETCH ----
const FETCH0 = ms('FETCH0', [0,0, 0,0,0, 0,0, 0,1,1,0,0, 0,1,0,0,0, 0,0],
  'PC drives bus. Load A and MAR with current PC value.');
const FETCH1 = ms('FETCH1', [0,0, 0,0,0, 0,0, 0,0,0,1,0, 0,0,0,1,0, 0,0],
  'Memory outputs instruction at address in MAR. Load IR from bus.');
const FETCH2 = ms('FETCH2', [0,0, 0,1,1, 0,0, 0,0,0,0,1, 0,0,1,0,0, 0,0],
  'ALU computes A+1 (incrementing old PC). Result drives bus and loads new PC. Opcode decoded to select next microstate.');

// ---- ADD ----
const ADD0 = ms('ADD0', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR1) to bus via DrREG. Load register A.');
const ADD1 = ms('ADD1', [1,0, 0,0,0, 0,0, 1,0,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Rz] (SR2) to bus via DrREG. Load register B.');
const ADD2 = ms('ADD2', [0,0, 0,0,0, 0,1, 0,0,0,0,0, 0,0,1,0,0, 0,0],
  'ALU computes A + B (ADD). Result drives bus. Write to Reg[Rx] (DR).');

// ---- NAND ----
const NAND0 = ms('NAND0', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR1) to bus via DrREG. Load register A.');
const NAND1 = ms('NAND1', [1,0, 0,0,0, 0,0, 1,0,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Rz] (SR2) to bus via DrREG. Load register B.');
const NAND2 = ms('NAND2', [0,0, 0,1,0, 0,1, 0,0,0,0,0, 0,0,1,0,0, 0,0],
  'ALU computes A NAND B. Result drives bus. Write to Reg[Rx] (DR).');

// ---- ADDI ----
const ADDI0 = ms('ADDI0', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR1) to bus via DrREG. Load register A.');
const ADDI1 = ms('ADDI1', [0,0, 0,0,0, 0,0, 1,0,0,0,0, 1,0,0,0,0, 0,0],
  'Sign-extend immediate (IR[19:0]) drives bus via DrOFF. Load register B.');
const ADDI2 = ms('ADDI2', [0,0, 0,0,0, 0,1, 0,0,0,0,0, 0,0,1,0,0, 0,0],
  'ALU computes A + B (SR1 + imm). Result drives bus. Write to Reg[Rx] (DR).');

// ---- LW ----
const LW0 = ms('LW0', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (BaseR) to bus via DrREG. Load register A.');
const LW1 = ms('LW1', [0,0, 0,0,0, 0,0, 1,0,0,0,0, 1,0,0,0,0, 0,0],
  'Sign-extend offset (IR[19:0]) drives bus via DrOFF. Load register B.');
const LW2 = ms('LW2', [0,0, 0,0,0, 0,0, 0,0,1,0,0, 0,0,1,0,0, 0,0],
  'ALU computes BaseR + offset (effective address). Result loads MAR.');
const LW3 = ms('LW3', [0,0, 0,0,0, 0,1, 0,0,0,0,0, 0,0,0,1,0, 0,0],
  'Memory outputs data at MAR address. DrMEM drives bus. Write to Reg[Rx] (DR).');

// ---- SW ----
const SW0 = ms('SW0', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (BaseR) to bus via DrREG. Load register A.');
const SW1 = ms('SW1', [0,0, 0,0,0, 0,0, 1,0,0,0,0, 1,0,0,0,0, 0,0],
  'Sign-extend offset (IR[19:0]) drives bus via DrOFF. Load register B.');
const SW2 = ms('SW2', [0,0, 0,0,0, 0,0, 0,0,1,0,0, 0,0,1,0,0, 0,0],
  'ALU computes BaseR + offset (effective address). Result loads MAR.');
const SW3 = ms('SW3', [0,0, 0,0,0, 1,0, 0,0,0,0,0, 0,0,0,0,1, 0,0],
  'Reg[Rx] (SR) drives bus via DrREG. Write bus data to Memory[MAR].');

// ---- BEQ ----
const BEQ0 = ms('BEQ0', [0,0, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Rx] (SR1) to bus via DrREG. Load register A.');
const BEQ1 = ms('BEQ1', [0,1, 0,0,0, 0,0, 1,0,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR2) to bus via DrREG. Load register B.');
const BEQ2 = ms('BEQ2', [0,0, 0,0,1, 0,0, 0,0,0,0,0, 0,0,1,0,0, 1,0],
  'ALU computes A - B (SUB). Comparison logic checks if result = 0 (equal). If equal, branch is taken.');

// ---- BEQ/BGT branch-taken ----
const BEQ_BGT4 = ms('BEQ/BGT4', [0,0, 0,0,0, 0,0, 0,1,0,0,0, 0,1,0,0,0, 0,0],
  'Branch taken: PC drives bus. Load register A with current PC value.');
const BEQ_BGT5 = ms('BEQ/BGT5', [0,0, 0,0,0, 0,0, 1,0,0,0,0, 1,0,0,0,0, 0,0],
  'Sign-extend offset (IR[19:0]) drives bus via DrOFF. Load register B.');
const BEQ_BGT6 = ms('BEQ/BGT6', [0,0, 0,0,0, 0,0, 0,0,0,0,1, 0,0,1,0,0, 0,0],
  'ALU computes PC + offset. Result drives bus and loads PC (branch target address).');

// ---- JALR ----
const JALR0 = ms('JALR0', [0,1, 0,0,0, 0,1, 0,0,0,0,0, 0,1,0,0,0, 0,0],
  'PC drives bus via DrPC. Write current PC to Reg[Ry] (RA) as return address.');
const JALR1 = ms('JALR1', [0,0, 0,0,0, 0,0, 0,0,0,0,1, 0,0,0,0,1, 0,0],
  'Read Reg[Rx] (AT / target) to bus via DrREG. Load PC with jump target address.');

// ---- HALT ----
const HALT0 = ms('HALT', [0,0, 0,0,0, 0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0],
  'HALT: All signals deasserted. Processor execution stops. No state changes occur.');

// ---- BGT ----
const BGT1 = ms('BGT1', [0,0, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Rx] (SR1) to bus via DrREG. Load register A.');
const BGT2 = ms('BGT2', [0,1, 0,0,0, 0,0, 1,0,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR2) to bus via DrREG. Load register B.');
const BGT3 = ms('BGT3', [0,0, 0,0,1, 0,0, 0,0,0,0,0, 0,0,1,0,0, 1,1],
  'ALU computes A - B (SUB). Comparison logic checks if result > 0. If greater, branch is taken.');

// ---- LEA ----
const LEA1 = ms('LEA1', [0,0, 0,0,0, 0,0, 0,1,0,0,0, 0,1,0,0,0, 0,0],
  'PC drives bus via DrPC. Load register A with current PC value.');
const LEA2 = ms('LEA2', [0,0, 0,0,0, 0,0, 1,0,0,0,0, 1,0,0,0,0, 0,0],
  'Sign-extend offset (IR[19:0]) drives bus via DrOFF. Load register B.');
const LEA3 = ms('LEA3', [0,0, 0,0,0, 0,1, 0,0,0,0,0, 0,0,1,0,0, 0,0],
  'ALU computes PC + offset. Result drives bus. Write to Reg[Rx] (DR).');

// ---- MIN ----
const MIN1 = ms('MIN1', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR1) to bus via DrREG. Load register A.');
const MIN2 = ms('MIN2', [1,0, 0,0,0, 0,0, 1,0,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Rz] (SR2) to bus via DrREG. Load register B.');
const MIN3 = ms('MIN3', [0,0, 0,0,1, 0,0, 0,0,0,0,0, 0,0,1,0,0, 0,1],
  'ALU computes A - B (SUB). Comparison logic determines which is smaller.');
const MINMAX4 = ms('MIN/MAX4', [0,0, 1,0,0, 0,1, 0,0,0,0,0, 0,0,1,0,0, 0,0],
  'ALU passes A (PASS A). Result drives bus. Write to Reg[Rx] (DR). A was the selected value.');
const MINMAX5 = ms('MIN/MAX5', [0,0, 1,0,1, 0,1, 0,0,0,0,0, 0,0,1,0,0, 0,0],
  'ALU passes B (PASS B). Result drives bus. Write to Reg[Rx] (DR). B was the selected value.');

// ---- MAX ----
const MAX1 = ms('MAX1', [0,1, 0,0,0, 0,0, 0,1,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Ry] (SR1) to bus via DrREG. Load register A.');
const MAX2 = ms('MAX2', [1,0, 0,0,0, 0,0, 1,0,0,0,0, 0,0,0,0,1, 0,0],
  'Read Reg[Rz] (SR2) to bus via DrREG. Load register B.');
const MAX3 = ms('MAX3', [0,0, 0,0,1, 0,0, 0,0,0,0,0, 0,0,1,0,0, 1,1],
  'ALU computes A - B (SUB). Comparison logic determines which is larger.');

/* ============================================================
   INSTRUCTION DEFINITIONS
   ============================================================ */
const INSTRUCTIONS = {
  'ADD':               [FETCH0, FETCH1, FETCH2, ADD0, ADD1, ADD2],
  'NAND':              [FETCH0, FETCH1, FETCH2, NAND0, NAND1, NAND2],
  'ADDI':              [FETCH0, FETCH1, FETCH2, ADDI0, ADDI1, ADDI2],
  'LW':                [FETCH0, FETCH1, FETCH2, LW0, LW1, LW2, LW3],
  'SW':                [FETCH0, FETCH1, FETCH2, SW0, SW1, SW2, SW3],
  'BEQ (not taken)':   [FETCH0, FETCH1, FETCH2, BEQ0, BEQ1, BEQ2],
  'BEQ (taken)':       [FETCH0, FETCH1, FETCH2, BEQ0, BEQ1, BEQ2, BEQ_BGT4, BEQ_BGT5, BEQ_BGT6],
  'JALR':              [FETCH0, FETCH1, FETCH2, JALR0, JALR1],
  'HALT':              [FETCH0, FETCH1, FETCH2, HALT0],
  'BGT (not taken)':   [FETCH0, FETCH1, FETCH2, BGT1, BGT2, BGT3],
  'BGT (taken)':       [FETCH0, FETCH1, FETCH2, BGT1, BGT2, BGT3, BEQ_BGT4, BEQ_BGT5, BEQ_BGT6],
  'LEA':               [FETCH0, FETCH1, FETCH2, LEA1, LEA2, LEA3],
  'MIN (A < B)':       [FETCH0, FETCH1, FETCH2, MIN1, MIN2, MIN3, MINMAX4],
  'MIN (A >= B)':      [FETCH0, FETCH1, FETCH2, MIN1, MIN2, MIN3, MINMAX5],
  'MAX (A > B)':       [FETCH0, FETCH1, FETCH2, MAX1, MAX2, MAX3, MINMAX4],
  'MAX (A <= B)':      [FETCH0, FETCH1, FETCH2, MAX1, MAX2, MAX3, MINMAX5],
};

/* ============================================================
   ALU / REGSEL DECODE
   ============================================================ */
function decodeALU(a2, a1, a0) {
  const code = (a2 << 2) | (a1 << 1) | a0;
  return ['ADD','SUB','NAND','A+1','PASS A','PASS B','--','--'][code];
}
function decodeRegSel(hi, lo) {
  const code = (hi << 1) | lo;
  return ['Rx','Ry','Rz','$ra'][code];
}

/* ============================================================
   HIGHLIGHT MAP
   Maps control signals to SVG elements to highlight.
   Paths from top bus to components use short segments.
   Paths from components to bottom bus go through tri-states.
   ============================================================ */
const HIGHLIGHT_MAP = {
  DrPC:  { components: ['comp-pc'], paths: ['path-pc-down','path-DrPC-bus'], triStates: ['tri-DrPC'], labels: ['lbl-DrPC'], junctions: ['junc-bot-pc'] },
  LdPC:  { components: ['comp-pc'], paths: ['path-bus-pc'], triStates: [], labels: ['lbl-LdPC'], junctions: ['junc-top-pc'] },
  LdA:   { components: ['comp-a'], paths: ['path-bus-a'], triStates: [], labels: ['lbl-LdA'], junctions: ['junc-top-a'] },
  LdB:   { components: ['comp-b'], paths: ['path-bus-b'], triStates: [], labels: ['lbl-LdB'], junctions: ['junc-top-b'] },
  LdMAR: { components: ['comp-mar'], paths: ['path-bus-mar'], triStates: [], labels: ['lbl-LdMAR'], junctions: ['junc-top-mar'] },
  LdIR:  { components: ['comp-ir'], paths: ['path-bus-ir'], triStates: [], labels: ['lbl-LdIR'], junctions: ['junc-top-ir'] },
  DrALU: { components: ['comp-alu'], paths: ['path-a-alu','path-b-alu','path-alu-down','path-DrALU-bus'], triStates: ['tri-DrALU'], labels: ['lbl-DrALU'], junctions: ['junc-bot-alu'] },
  DrREG: { components: ['comp-regfile'], paths: ['path-regfile-down','path-DrREG-bus'], triStates: ['tri-DrREG'], labels: ['lbl-DrREG'], junctions: ['junc-bot-reg'] },
  DrMEM: { components: ['comp-mem','comp-mar'], paths: ['path-mem-down','path-DrMEM-bus','path-mar-mem'], triStates: ['tri-DrMEM'], labels: ['lbl-DrMEM'], junctions: ['junc-bot-mem'] },
  DrOFF: { components: ['comp-se','comp-ir'], paths: ['path-se-down','path-DrOFF-bus','path-ir-se', 'path-bl-se'], triStates: ['tri-DrOFF'], labels: ['lbl-DrOFF'], junctions: ['junc-bot-off'] },
  WrREG: { components: ['comp-regfile'], paths: ['path-bus-regfile'], triStates: [], labels: ['lbl-WrREG'], junctions: ['junc-top-reg'] },
  WrMEM: { components: ['comp-mem','comp-mar'], paths: ['path-bus-mem-din','path-mar-mem'], triStates: [], labels: ['lbl-WrMEM'], junctions: ['junc-top-memdin'] },
  ChkCmpHi: { components: ['comp-cmp'], paths: ['path-alu-cmp','path-cmp-out', 'path-cmp-out-2'], triStates: [], labels: ['lbl-ChkCmp'], junctions: ['junc-bot-cmp'] },
  ChkCmpLo: { components: ['comp-cmp'], paths: ['path-alu-cmp','path-cmp-out','path-cmp-out-2'], triStates: [], labels: ['lbl-ChkCmp'], junctions: ['junc-bot-cmp'] },
};

const EXTRA_COMPONENTS_DRALU = ['comp-a','comp-b'];

/* ============================================================
   ANIMATION FLOW ROUTES
   Maps drive signals to source waypoints and load signals to
   destination waypoints. The bus U-path connects them.
   ============================================================ */
const DRIVE_SOURCES = {
  DrPC:  [[105,85], [105,375], [105,400]],
  DrALU: [[275,280], [275,375], [275,400]],
  DrREG: [[475,240], [475,375], [475,400]],
  DrMEM: [[665,240], [665,375], [665,400]],
  DrOFF: [[870,240], [870,375], [870,400]],
};

const LOAD_DESTS = {
  LdPC:  { busX: 105, end: [105,45] },
  LdA:   { busX: 210, end: [210,45] },
  LdB:   { busX: 350, end: [350,45] },
  LdMAR: { busX: 625, end: [625,45] },
  LdIR:  { busX: 870, end: [870,45] },
  WrREG: { busX: 475, end: [475,130] },
  WrMEM: { busX: 695, end: [695,130] },
};

function buildFlowRoute(state) {
  const sig = state.signals;

  // Find active drive signal
  let driveKey = null;
  for (const key of Object.keys(DRIVE_SOURCES)) {
    if (sig[key]) { driveKey = key; break; }
  }
  if (!driveKey) return null;

  // Find first active load/write destination
  let destKey = null;
  for (const key of Object.keys(LOAD_DESTS)) {
    if (sig[key]) { destKey = key; break; }
  }
  if (!destKey) return null;

  const srcPts = DRIVE_SOURCES[driveKey];
  const dest = LOAD_DESTS[destKey];

  // Build waypoints: source → bottom bus → left corner → top bus → destination
  const waypoints = [
    ...srcPts,
    [20, 400],   // bottom-left corner
    [20, 12],    // top-left corner
    [dest.busX, 12],  // along top bus to destination x
    dest.end     // down into component
  ];

  // Convert to SVG path d attribute
  const d = waypoints.map((p, i) => (i === 0 ? 'M' : 'L') + p[0] + ',' + p[1]).join(' ');
  return d;
}

/* ============================================================
   DOM REFERENCES
   ============================================================ */
const instrSelect = document.getElementById('instr-select');
const btnPrev = document.getElementById('btn-prev');
const btnNext = document.getElementById('btn-next');
const cycleCounter = document.getElementById('cycle-counter');
const stateName = document.getElementById('state-name');
const cycleDescription = document.getElementById('cycle-description');
const aluInfoBox = document.getElementById('alu-info-box');
const regInfoBox = document.getElementById('reg-info-box');
const aluFuncText = document.getElementById('alu-func-text');
const regnoText = document.getElementById('regno-text');

let currentInstr = 'ADD';
let currentCycle = 0;
let showFetch = true;
let animateFlow = true;
const fetchToggle = document.getElementById('fetch-toggle');
const animToggle = document.getElementById('anim-toggle');
const animDot = document.getElementById('anim-dot');
const animRoute = document.getElementById('anim-route');

function getActiveCycles() {
  const all = INSTRUCTIONS[currentInstr];
  return showFetch ? all : all.filter(s => !s.name.startsWith('FETCH'));
}

/* ============================================================
   POPULATE DROPDOWN
   ============================================================ */
Object.keys(INSTRUCTIONS).forEach(name => {
  const opt = document.createElement('option');
  opt.value = name;
  opt.textContent = name;
  instrSelect.appendChild(opt);
});

/* ============================================================
   CLEAR ALL HIGHLIGHTS
   ============================================================ */
function clearHighlights() {
  document.querySelectorAll('.comp-rect').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.data-path').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tri-state').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.signal-label').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.ctrl-line').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.bus-junction').forEach(el => el.classList.remove('active'));
  document.getElementById('bus-main').classList.remove('active-bus');

  SIGNAL_NAMES.forEach(n => {
    const el = document.getElementById('sig-' + n);
    if (el) {
      el.classList.remove('active');
      el.querySelector('.signal-value').textContent = '0';
    }
  });

  // Stop animation
  animDot.setAttribute('opacity', '0');
  const oldAnim = animDot.querySelector('animateMotion');
  if (oldAnim) oldAnim.remove();
}

/* ============================================================
   APPLY HIGHLIGHTS FOR A MICROSTATE
   ============================================================ */
function applyState(state) {
  clearHighlights();

  const sig = state.signals;
  let busActive = false;

  SIGNAL_NAMES.forEach(name => {
    const val = sig[name] || 0;
    const panelEl = document.getElementById('sig-' + name);
    if (panelEl) {
      panelEl.querySelector('.signal-value').textContent = val;
      if (val === 1) panelEl.classList.add('active');
    }

    if (val === 1 && HIGHLIGHT_MAP[name]) {
      busActive = true;
      const hm = HIGHLIGHT_MAP[name];
      hm.components.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      });
      hm.paths.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      });
      hm.triStates.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      });
      (hm.junctions || []).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      });
      hm.labels.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      });
    }
  });

  // When DrALU active, also highlight A and B components
  if (sig.DrALU) {
    EXTRA_COMPONENTS_DRALU.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
    });
  }

  // When DrALU + LdMAR both active, highlight MAR
  if (sig.DrALU && sig.LdMAR) {
    document.getElementById('comp-mar').classList.add('active');
  }

  // Highlight bus if anything is driving/loading
  if (busActive) {
    document.getElementById('bus-main').classList.add('active-bus');
  }

  // Highlight active control lines
  ['LdPC','LdA','LdB','LdMAR','LdIR','WrREG','WrMEM'].forEach(name => {
    if (sig[name]) {
      const el = document.getElementById('ctrl-' + name);
      if (el) el.classList.add('active');
    }
  });
  if (sig.ChkCmpHi || sig.ChkCmpLo) {
    const el = document.getElementById('ctrl-ChkCmp');
    if (el) el.classList.add('active');
  }

  // ALU function display
  const aluFunc = decodeALU(sig.ALU2, sig.ALU1, sig.ALU0);
  aluFuncText.textContent = 'func: ' + aluFunc;
  if (sig.DrALU) {
    aluInfoBox.textContent = 'ALU Function: ' + aluFunc;
    aluFuncText.style.fill = '#e74c3c';
  } else {
    aluInfoBox.textContent = '';
    aluFuncText.style.fill = '#7f8c8d';
  }

  // Register select display
  const regSel = decodeRegSel(sig.RegSelHi, sig.RegSelLo);
  regnoText.textContent = regSel;
  if (sig.DrREG || sig.WrREG) {
    regInfoBox.textContent = 'Register Select: ' + regSel;
    regnoText.style.fill = '#e74c3c';
  } else {
    regInfoBox.textContent = '';
    regnoText.style.fill = '#2980b9';
  }

  // Update cycle info
  const cycles = getActiveCycles();
  cycleCounter.textContent = 'Cycle ' + (currentCycle + 1) + ' / ' + cycles.length;
  stateName.textContent = state.name;
  cycleDescription.textContent = state.description;

  btnPrev.disabled = (currentCycle === 0);
  btnNext.disabled = (currentCycle >= cycles.length - 1);

  // Animate data flow pulse
  if (animateFlow) {
    const routeD = buildFlowRoute(state);
    if (routeD) {
      animRoute.setAttribute('d', routeD);
      animDot.setAttribute('opacity', '0.9');
      const motion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
      motion.setAttribute('dur', '1.8s');
      motion.setAttribute('repeatCount', 'indefinite');
      motion.setAttribute('fill', 'freeze');
      const mpath = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
      mpath.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '#anim-route');
      motion.appendChild(mpath);
      animDot.appendChild(motion);
    }
  }
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function goToCycle(n) {
  const cycles = getActiveCycles();
  if (n < 0 || n >= cycles.length) return;
  currentCycle = n;
  applyState(cycles[currentCycle]);
}

instrSelect.addEventListener('change', () => {
  currentInstr = instrSelect.value;
  currentCycle = 0;
  goToCycle(0);
});

fetchToggle.addEventListener('change', () => {
  showFetch = fetchToggle.checked;
  currentCycle = 0;
  goToCycle(0);
});

animToggle.addEventListener('change', () => {
  animateFlow = animToggle.checked;
  goToCycle(currentCycle);
});

btnPrev.addEventListener('click', () => goToCycle(currentCycle - 1));
btnNext.addEventListener('click', () => goToCycle(currentCycle + 1));

document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
    e.preventDefault();
    goToCycle(currentCycle - 1);
  } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
    e.preventDefault();
    goToCycle(currentCycle + 1);
  }
});

goToCycle(0);
</script>
</body>
</html>
